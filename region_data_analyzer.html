<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Region Data Analysis Tool</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .button { padding: 12px 24px; margin: 8px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .button:hover { background: #0056b3; }
        .button.secondary { background: #6c757d; }
        .button.danger { background: #dc3545; }
        .result { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #007bff; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .success { border-left-color: #28a745; background: #d4edda; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        .log { background: #e9ecef; padding: 10px; margin: 5px 0; border-radius: 3px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: #e3f2fd; padding: 15px; border-radius: 5px; text-align: center; }
        .stat-number { font-size: 24px; font-weight: bold; color: #1976d2; }
        .stat-label { font-size: 14px; color: #666; margin-top: 5px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Region Data Analysis Tool</h1>
        <p>This tool helps debug the Region Roadmap data issues by testing the API and processRegionData function.</p>
        
        <div>
            <button class="button" onclick="testAPIConnectivity()">üîå Test API Connectivity</button>
            <button class="button" onclick="analyzeSupplyChainData()">‚öôÔ∏è Analyze Supply Chain Data</button>
            <button class="button" onclick="testAllFilters()">üîç Test All Filter Combinations</button>
            <button class="button" onclick="exportAllDataToJSON()">üìÅ Export Data to JSON Files</button>
            <button class="button secondary" onclick="clearResults()">üóëÔ∏è Clear Results</button>
        </div>

        <div id="stats" class="stats hidden"></div>
        <div id="results"></div>
    </div>

    <script>
        let globalData = {};

        function addResult(title, content, type = 'result') {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `<h3>${title}</h3><div class="log">${content}</div>`;
            resultsDiv.appendChild(resultDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function updateStats(data) {
            const statsDiv = document.getElementById('stats');
            statsDiv.className = 'stats';
            statsDiv.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${data.totalRecords || 0}</div>
                    <div class="stat-label">Total Investment Records</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${data.afterTypeFilter || 0}</div>
                    <div class="stat-label">After Type Filter</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${data.uniqueProjects || 0}</div>
                    <div class="stat-label">Unique Projects</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${data.supplyChainProjects || 0}</div>
                    <div class="stat-label">Supply Chain Projects</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${data.validProjects || 0}</div>
                    <div class="stat-label">Valid Projects (All Filters)</div>
                </div>
            `;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('stats').className = 'stats hidden';
        }

        async function testAPIConnectivity() {
            try {
                addResult('üîå Testing API Connectivity...', 'Starting connectivity tests...', 'warning');
                
                // Test /api/data endpoint
                const dataResponse = await fetch('/api/data');
                const dataResult = await dataResponse.json();
                
                // Test /api/investments endpoint
                const investResponse = await fetch('/api/investments?page=1&per_page=100');
                const investResult = await investResponse.json();
                
                const connectivityReport = `
‚úÖ API Connectivity Test Results:

/api/data endpoint:
  - Status: ${dataResult.status}
  - Hierarchy records: ${dataResult.data?.hierarchy?.length || 0}
  - Investment records: ${dataResult.data?.investment?.length || 0}
  - Mode: ${dataResult.mode}

/api/investments endpoint:
  - Status: ${investResult.status}
  - Total records: ${investResult.total || 0}
  - Current page: ${investResult.page || 0}
  - Per page: ${investResult.per_page || 0}
  - Records returned: ${investResult.data?.length || 0}

Sample investment records:
${investResult.data?.slice(0, 3).map(item => `  - ${item.INVESTMENT_NAME} (${item.INV_FUNCTION}, ${item.INV_MARKET})`).join('\n') || 'No records'}
                `;
                
                addResult('‚úÖ API Connectivity Test', connectivityReport, 'success');
                
                globalData.connectivity = {
                    dataEndpoint: dataResult,
                    investEndpoint: investResult
                };
                
            } catch (error) {
                addResult('‚ùå API Connectivity Test Failed', `Error: ${error.message}`, 'error');
            }
        }

        async function analyzeSupplyChainData() {
            try {
                addResult('‚öôÔ∏è Analyzing Supply Chain Data...', 'Fetching and analyzing Supply Chain projects...', 'warning');
                
                // Fetch all investment data
                const response = await fetch('/api/investments?page=1&per_page=2000');
                const result = await response.json();
                const investmentData = result.data || [];
                
                // Find all Supply Chain records
                const supplyChainRecords = investmentData.filter(item => 
                    item.INV_FUNCTION === 'Supply Chain'
                );
                
                // Group by project ID
                const supplyChainGroups = {};
                supplyChainRecords.forEach(item => {
                    if (!supplyChainGroups[item.INV_EXT_ID]) {
                        supplyChainGroups[item.INV_EXT_ID] = [];
                    }
                    supplyChainGroups[item.INV_EXT_ID].push(item);
                });
                
                let validProjects = 0;
                let invalidProjects = 0;
                const projectAnalysis = [];
                
                Object.keys(supplyChainGroups).forEach(projectId => {
                    const records = supplyChainGroups[projectId];
                    const investmentRecord = records.find(r => r.ROADMAP_ELEMENT === 'Investment');
                    
                    const analysis = {
                        id: projectId,
                        name: investmentRecord?.INVESTMENT_NAME || 'NO INVESTMENT RECORD',
                        hasInvestmentRecord: !!investmentRecord,
                        hasValidMarket: !!(investmentRecord?.INV_MARKET && 
                                         investmentRecord.INV_MARKET.trim() !== '' && 
                                         investmentRecord.INV_MARKET !== '-Unrecognised-'),
                        market: investmentRecord?.INV_MARKET || 'NO MARKET',
                        type: investmentRecord?.CLRTY_INV_TYPE || 'NO TYPE',
                        isCorrectType: investmentRecord && ["Non-Clarity item", "Project", "Programs"].includes(investmentRecord.CLRTY_INV_TYPE),
                        recordCount: records.length
                    };
                    
                    analysis.isValid = analysis.hasInvestmentRecord && analysis.hasValidMarket && analysis.isCorrectType;
                    
                    if (analysis.isValid) validProjects++;
                    else invalidProjects++;
                    
                    projectAnalysis.push(analysis);
                });
                
                const report = `
üìä Supply Chain Data Analysis:

Total Supply Chain records: ${supplyChainRecords.length}
Unique Supply Chain projects: ${Object.keys(supplyChainGroups).length}
Valid projects (would be processed): ${validProjects}
Invalid projects (would be skipped): ${invalidProjects}

üîç Project Details:
${projectAnalysis.slice(0, 10).map(p => `
  ${p.isValid ? '‚úÖ' : '‚ùå'} ${p.id} - ${p.name}
     Market: ${p.market}
     Type: ${p.type}
     Valid: Investment=${p.hasInvestmentRecord}, Market=${p.hasValidMarket}, Type=${p.isCorrectType}
`).join('')}

${projectAnalysis.length > 10 ? `... and ${projectAnalysis.length - 10} more projects` : ''}

‚ùå Invalid Projects Summary:
${projectAnalysis.filter(p => !p.isValid).slice(0, 5).map(p => `
  - ${p.name}: Missing ${!p.hasInvestmentRecord ? 'Investment Record' : !p.hasValidMarket ? 'Valid Market' : 'Correct Type'}
`).join('')}
                `;
                
                addResult('‚öôÔ∏è Supply Chain Analysis Complete', report, 'success');
                
                globalData.supplyChain = {
                    total: supplyChainRecords.length,
                    unique: Object.keys(supplyChainGroups).length,
                    valid: validProjects,
                    invalid: invalidProjects,
                    details: projectAnalysis
                };
                
                updateStats({
                    totalRecords: investmentData.length,
                    supplyChainProjects: Object.keys(supplyChainGroups).length,
                    validProjects: validProjects
                });
                
            } catch (error) {
                addResult('‚ùå Supply Chain Analysis Failed', `Error: ${error.message}`, 'error');
            }
        }

        async function testAllFilters() {
            try {
                addResult('üîç Testing Filter Combinations...', 'Testing processRegionData with various filters...', 'warning');
                
                const testFilters = [
                    { region: 'All', market: 'All', function: 'All', tier: 'All' },
                    { region: 'All', market: 'All', function: 'Supply Chain', tier: 'All' },
                    { region: 'All', market: 'All', function: 'Commercial', tier: 'All' },
                    { region: 'EMEA', market: 'All', function: 'All', tier: 'All' },
                    { region: 'Global', market: 'All', function: 'All', tier: 'All' },
                    { region: 'All', market: 'All', function: 'All', tier: '1' }
                ];
                
                // We need to simulate processRegionData since we can't import it directly
                const investResponse = await fetch('/api/investments?page=1&per_page=2000');
                const investResult = await investResponse.json();
                const investmentData = investResult.data || [];
                
                let report = 'üîç Filter Test Results:\n\n';
                
                for (const filters of testFilters) {
                    const filterName = Object.entries(filters)
                        .filter(([key, value]) => value !== 'All')
                        .map(([key, value]) => `${key}=${value}`)
                        .join(', ') || 'No filters';
                    
                    // Simulate the processRegionData logic
                    const projectData = investmentData.filter(item =>
                        ["Non-Clarity item", "Project", "Programs"].includes(item.CLRTY_INV_TYPE)
                    );
                    
                    const projectGroups = {};
                    projectData.forEach(item => {
                        if (!projectGroups[item.INV_EXT_ID]) {
                            projectGroups[item.INV_EXT_ID] = [];
                        }
                        projectGroups[item.INV_EXT_ID].push(item);
                    });
                    
                    let validProjects = 0;
                    
                    Object.keys(projectGroups).forEach(projectId => {
                        const projectItems = projectGroups[projectId];
                        
                        const itemsWithMarket = projectItems.filter(item => 
                            item.INV_MARKET && 
                            item.INV_MARKET.trim() !== '' &&
                            item.INV_MARKET !== '-Unrecognised-'
                        );
                        
                        if (itemsWithMarket.length === 0) return;
                        
                        const mainRecord = itemsWithMarket.find(item =>
                            item.ROADMAP_ELEMENT === "Investment"
                        );
                        
                        if (!mainRecord) return;
                        
                        // Parse market
                        const parts = mainRecord.INV_MARKET.split('/');
                        const region = parts[0] || '';
                        const market = parts[1] || '';
                        
                        // Apply filters
                        if (filters.region !== 'All' && region !== filters.region) return;
                        if (filters.market !== 'All' && market !== filters.market) return;
                        if (filters.function !== 'All' && mainRecord.INV_FUNCTION !== filters.function) return;
                        if (filters.tier !== 'All' && mainRecord.INV_TIER?.toString() !== filters.tier) return;
                        
                        validProjects++;
                    });
                    
                    report += `üìä ${filterName}: ${validProjects} projects\n`;
                }
                
                addResult('üîç Filter Test Complete', report, 'success');
                
            } catch (error) {
                addResult('‚ùå Filter Test Failed', `Error: ${error.message}`, 'error');
            }
        }

        async function exportAllDataToJSON() {
            try {
                addResult('üìÅ Exporting Data to JSON...', 'Generating comprehensive data export files...', 'warning');
                
                // Get raw API data
                const apiResponse = await fetch('/api/data');
                const apiData = await apiResponse.json();
                
                // Get investment data
                const investResponse = await fetch('/api/investments?page=1&per_page=2000');
                const investResult = await investResponse.json();
                const investmentData = investResult.data || [];
                
                // Export 1: Raw API data
                const rawBlob = new Blob([JSON.stringify(apiData, null, 2)], { type: 'application/json' });
                const rawUrl = URL.createObjectURL(rawBlob);
                const rawLink = document.createElement('a');
                rawLink.href = rawUrl;
                rawLink.download = 'raw_api_data.json';
                rawLink.click();
                
                // Export 2: All investment data
                const investBlob = new Blob([JSON.stringify(investmentData, null, 2)], { type: 'application/json' });
                const investUrl = URL.createObjectURL(investBlob);
                const investLink = document.createElement('a');
                investLink.href = investUrl;
                investLink.download = 'all_investment_data.json';
                investLink.click();
                
                // Export 3: Supply Chain analysis if available
                if (globalData.supplyChain) {
                    const scBlob = new Blob([JSON.stringify(globalData.supplyChain, null, 2)], { type: 'application/json' });
                    const scUrl = URL.createObjectURL(scBlob);
                    const scLink = document.createElement('a');
                    scLink.href = scUrl;
                    scLink.download = 'supply_chain_analysis.json';
                    scLink.click();
                }
                
                addResult('üìÅ Export Complete', `
Files exported to Downloads folder:
‚úÖ raw_api_data.json - Raw API response from /api/data
‚úÖ all_investment_data.json - All investment records from /api/investments
${globalData.supplyChain ? '‚úÖ supply_chain_analysis.json - Supply Chain analysis' : '‚ö†Ô∏è supply_chain_analysis.json - Run Supply Chain analysis first'}

Total records exported: ${investmentData.length}
                `, 'success');
                
            } catch (error) {
                addResult('‚ùå Export Failed', `Error: ${error.message}`, 'error');
            }
        }

        // Auto-run connectivity test on page load
        window.onload = function() {
            console.log('üöÄ Region Data Analysis Tool loaded');
            setTimeout(testAPIConnectivity, 1000);
        };
    </script>
</body>
</html>
